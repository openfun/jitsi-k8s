version: '3.4'

services:

  terraform-state:
    image: hashicorp/terraform:0.15.3
    env_file: env.d/terraform
    user: ${DOCKER_USER:-1000}
    working_dir: /app
    volumes:
      - ./terraform/create_state_bucket:/app

  terraform:
    image: hashicorp/terraform:0.15.3
    env_file: env.d/terraform
    user: ${DOCKER_USER:-1000}
    working_dir: /app
    environment:
      # Without this value, the Helm provider fails to fetch chart repository data
      - XDG_CACHE_HOME=/tmp
      #
    volumes:
      - ./terraform:/app

  kubectl:
    image: bitnami/kubectl:latest
    user: ${DOCKER_USER:-1000}
    volumes:
      - ./terraform/.kubeconfig-${JITSI_K8S_ENV:-"default"}:/.kube/config

  kustomize:
    image: k8s.gcr.io/kustomize/kustomize:v4.2.0
    user: ${DOCKER_USER:-1000}
    volumes:
      - ./k8s:/data/k8s
      - ./env.d/jitsi.env-${JITSI_K8S_ENV:-"default"}:/data/env.d/jitsi
      - ./env.d/jitsi-secrets.env-${JITSI_K8S_ENV:-"default"}:/data/env.d/jitsi-secrets
